# //////////////////////////////////////////////
# DarkSlack theme main script
# (C) LazzR 2019, F44 Red, all rights reserved
# //////////////////////////////////////////////
if (!(Test-Path "$env:LOCALAPPDATA\slack\app-4*")){Write-Host 'Slack version 4.0.0 or above not found. Install required software and try again...';Read-Host;exit;}$7ZipInstallLocation = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\7-Zip -ErrorAction SilentlyContinue | Select-Object -ExpandProperty InstallLocation;$flag = 0;if(!$7ZipInstallLocation){$flag = 2;Write-Host '7-Zip is not installed along with required plugins. Downloading required components...';Write-Host;$webClient = New-Object System.Net.WebClient;$domainString = 'https://www.7-zip.org/';$asarPluginLocation = 'http://www.tc4shell.com/binary/Asar.zip';$asarPluginDownloadLocation = "$env:LOCALAPPDATA\temp\Asar.zip";$htmlString = $webClient.DownloadString("https://www.7-zip.org/download.html");$list = New-Object System.Collections.Generic.List[string];$index = 0;while($true){$index = $htmlString.IndexOf('href="',$index);if($index -eq -1){break;};$temp = $htmlString.Substring($index+6,$htmlString.IndexOf('"',$index+6)-$index-6);$list.Add($temp);$index=$index+1;}$index = 0;while($true){if(!$list[$index].Contains('exe')){$list.RemoveAt($index)}else{$index=$index+1}if($index -eq $list.Count){break;}}Write-Host 'Downloading 7-Zip...';$downloadUrl = $domainString + $list[0];$downloadLocation = "$env:LOCALAPPDATA\temp\7z_install.exe";$webClient.DownloadFile($downloadUrl, $downloadLocation);Write-Host 'Done.';Write-Host;Write-Host 'Installing 7-Zip...';Start-Process -Wait -FilePath $downloadLocation -ArgumentList '/S' |Out-Null;Write-Host 'Done.';Write-Host;Write-Host 'Downloading required asar plugin...';$webClient.DownloadFile($asarPluginLocation, $asarPluginDownloadLocation);Write-Host 'Done.';while($true) {$7ZipInstallLocation = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\7-Zip -ErrorAction SilentlyContinue | Select-Object -ExpandProperty InstallLocation;if($7ZipInstallLocation) {break;}}Set-Location $7ZipInstallLocation;Write-Host 'Setting up the asar plugin...';.\7z.exe x -y $asarPluginDownloadLocation | Out-Null;mkdir 'Formats' -f | Out-Null;move .\Asar.32.dll Formats | Out-Null;move .\Asar.64.dll Formats | Out-Null;Write-Host 'Done.';Write-Host;Write-Host 'Cleaning up temporary files...';Remove-Item $downloadLocation -Force | Out-Null;Remove-Item $asarPluginDownloadLocation -Force | Out-Null;Write-Host 'Done.';Write-Host;Write-Host '7-Zip installed along with required software.';Write-Host;}elseif($7ZipInstallLocation -and !(Test-Path "$7ZipInstallLocation\Formats\*asar*")){$flag = 1;Write-Host '7-Zip installed without needed plugins. Downloading required components.';Write-Host;$webClient = New-Object System.Net.WebClient;$asarPluginLocation = 'http://www.tc4shell.com/binary/Asar.zip';$asarPluginDownloadLocation = "$env:LOCALAPPDATA\temp\Asar.zip";Write-Host 'Downloading required asar plugin.';Write-Host;$webClient.DownloadFile($asarPluginLocation, $asarPluginDownloadLocation);while($true) {$7ZipInstallLocation = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\7-Zip -ErrorAction SilentlyContinue | Select-Object -ExpandProperty InstallLocation;if($7ZipInstallLocation) {break;}}Set-Location $7ZipInstallLocation | Out-Null;.\7z.exe x -y $asarPluginDownloadLocation | Out-Null;mkdir 'Formats' -f | Out-Null;move .\Asar.32.dll Formats | Out-Null;move .\Asar.64.dll Formats | Out-Null;Remove-Item $asarPluginDownloadLocation -Force | Out-Null;Write-Host '7-Zip installed along with required software.';Write-Host;}Set-Location $7ZipInstallLocation;$slackAppDirectory = Get-ChildItem -Path "$env:LOCALAPPDATA\slack" -Filter "app-4*" | Sort-Object LastAccessTime -Descending | Select-Object -First 1 -ExpandProperty Name;$slackDirectory = $env:LOCALAPPDATA + "\slack\" + $slackAppDirectory + "\resources";ps 'slack' -ErrorAction SilentlyContinue | Stop-Process -Force | Out-Null;
$darkTheme = '
document.addEventListener("DOMContentLoaded", function() {
  const cssPath =
    "https://cdn.rawgit.com/laCour/slack-night-mode/master/css/raw/black.css";
  let cssPromise = fetch(cssPath).then((response) => response.text());
  let customCustomCSS = `
   :root {
      --primary: #61AFEF;
      --text: #ABB2BF;
      --background: #282C34;
      --background-elevated: #3B4048;
   }
   `;
  cssPromise.then((css) => {
    let s = document.createElement("style");
    s.type = "text/css";
    s.innerHTML = css + customCustomCSS;
    document.head.appendChild(s);
  });
});
';
if(Test-Path "$slackDirectory\app") {Write-Host 'Already modified version of Slack found, applying theme...';Remove-Item "$slackDirectory\app" -Force -Recurse | Out-Null;if(Test-Path "$slackDirectory\app.asar.original") {Remove-Item "$slackDirectory\app.asar" -Force | Out-Null;Rename-Item -Path "$slackDirectory\app.asar.original" -NewName "app.asar" | Out-Null;}.\7z.exe x "$slackDirectory\app.asar" "-o$slackDirectory\app" -y | Out-Null;Add-Content "$slackDirectory\app\dist\ssb-interop.bundle.js" -Value $darkTheme | Out-Null;Move-Item "$slackDirectory\app.asar" "$slackDirectory\app.asar.original" | Out-Null;.\7z.exe a "$slackDirectory\app.asar" "$slackDirectory\app" | Out-Null;Write-Host 'Done.';Write-Host;}else {Write-Host 'An unmodified Slack version found. Applying theme...';.\7z.exe x "$slackDirectory\app.asar" "-o$slackDirectory\app" -y | Out-Null;Add-Content "$slackDirectory\app\dist\ssb-interop.bundle.js" -Value $darkTheme | Out-Null;Move-Item "$slackDirectory\app.asar" "$slackDirectory\app.asar.original" | Out-Null;.\7z.exe a "$slackDirectory\app.asar" "$slackDirectory\app" | Out-Null;Write-Host 'Done.';Write-Host;}if($flag -eq 2){Write-Host 'Unintalling a temporary instance of 7-Zip along with leftovers...';.\Uninstall.exe /S;Start-Sleep -s 5;Set-Location $slackDirectory | Out-Null;Remove-Item -Recurse -Force $7ZipInstallLocation -ErrorAction SilentlyContinue | Out-Null;Write-Host 'Done.';Write-Host;}Write-Host 'Press ENTER to continue...';Read-Host;